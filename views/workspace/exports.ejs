<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exports ‚Äî <%= workspace.name %></title>
  <link rel="stylesheet" href="/app.css">
  <style>
    .container{max-width:960px;margin:0 auto;padding:32px 20px;}
    h1{font-size:22px;font-weight:700;margin:0 0 4px;}
    .subtitle{color:var(--text-muted);font-size:14px;margin:0 0 28px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:20px;box-shadow:var(--shadow);}
    .section-title{font-size:13px;font-weight:600;color:var(--blue-light);text-transform:uppercase;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border);}
    .export-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;}
    .export-row:last-child{border-bottom:none;}
    .export-meta{font-size:13px;color:var(--text-muted);}
    .badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
    .badge-sent{background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.3);}
    .badge-pending{background:rgba(124,58,237,0.12);color:#a78bfa;border:1px solid rgba(124,58,237,0.3);}
    .badge-failed{background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.3);}
    .badge-queued{background:rgba(59,130,246,0.12);color:#60a5fa;border:1px solid rgba(59,130,246,0.3);}
    .dl-btn{padding:6px 14px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:var(--bg3);color:var(--text);border:1px solid var(--border2);text-decoration:none;display:inline-block;}
    .dl-btn:hover{border-color:var(--blue);color:var(--blue-light);}
    .gen-row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end;}
    .gen-row>div{flex:1;min-width:160px;}
    .export-name{font-size:14px;font-weight:600;color:var(--text);}
  </style>
</head>
<body id="appBody">
<%- include('../partials/header', { activeNav: '' }) %>
<div class="container">
  <h1>Compliance Exports</h1>
  <p class="subtitle">Generate and download PDF temperature sheet exports.</p>

  <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success">Export generation started.</div>
  <% } %>
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">Failed to generate export.</div>
  <% } %>

  <div class="card">
    <div class="section-title">Generate Export</div>
    <form method="POST" action="/app/exports/generate">
      <input type="hidden" name="_security-token" value="<%= csrfToken %>">
      <div class="gen-row">
        <div>
          <label>Period Start</label>
          <input type="date" name="periodStart" required placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label>Period End</label>
          <input type="date" name="periodEnd" required placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="submit" class="btn">Generate &amp; Download</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="section-title">Export Archive (<%= exports.length %> exports)</div>
    <% if (exports.length === 0) { %>
      <p style="color:var(--text-dim);font-size:14px;text-align:center;padding:24px 0">No exports yet. Use the form above to generate one.</p>
    <% } %>
    <% exports.forEach(exp => { %>
    <div class="export-row">
      <div>
        <div class="export-name"><%
          const fmtDate = d => { if (!d) return ''; const [y,m,dy] = String(d).split('-'); return dy && m && y ? `${dy}/${m}/${y}` : d; };
        %><%= fmtDate(exp.periodStart) %> ‚Üí <%= fmtDate(exp.periodEnd) %></div>
        <div class="export-meta">Generated: <%= new Date(exp.createdAt).toLocaleDateString('en-AU') %> &nbsp;|&nbsp; <%= exp.pdfCount %> PDFs &nbsp;|&nbsp; Type: <%= exp.type %></div>
        <% if (exp.emailedTo && exp.emailedTo.length > 0) { %>
          <div class="export-meta">Emailed to: <%= exp.emailedTo.join(', ') %></div>
        <% } %>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="badge badge-<%= exp.emailStatus || 'pending' %>"><%= exp.emailStatus || 'pending' %></span>
        <% if (exp.zipPath) { %>
          <a href="/app/exports/<%= exp.id %>/download" class="dl-btn">Download ZIP</a>
        <% } %>
      </div>
    </div>
    <% }) %>
  </div>
</div>
<script>
(function() {
  if (localStorage.getItem('thermio_theme') === 'light') {
    document.getElementById('appBody').classList.add('light-mode');
    const btn = document.getElementById('themeBtn');
    if (btn) btn.textContent = 'üåô';
  }
})();
function toggleDark() {
  const isLight = document.getElementById('appBody').classList.toggle('light-mode');
  localStorage.setItem('thermio_theme', isLight ? 'light' : 'dark');
  const btn = document.getElementById('themeBtn');
  if (btn) btn.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
}
function toggleHamburger() {
  document.getElementById('hamburgerDropdown').classList.toggle('open');
}
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('hamburgerWrap');
  if (wrap && !wrap.contains(e.target)) {
    document.getElementById('hamburgerDropdown').classList.remove('open');
  }
});
</script>
</body>
</html>
