<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= ws.name %> — Portal Admin</title>
  <link rel="stylesheet" href="/app.css">
  <style>
    .sa-header{background:#12151b;border-bottom:1px solid #2d3748;padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:56px;}
    .sa-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#6d28d9);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
    .sa-user{display:flex;align-items:center;gap:10px;}
    .sa-user-label{color:#9ca3af;font-size:13px;}
    .sa-user-name{color:#fff;font-weight:600;}
    .container{max-width:900px;margin:0 auto;padding:36px 28px;}
    h1{font-size:22px;font-weight:700;margin:0 0 4px;}
    .subtitle{color:#9ca3af;font-size:14px;margin:0 0 24px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;}
    @media(max-width:640px){.grid{grid-template-columns:1fr;}}
    .card{background:linear-gradient(180deg,#1f2328,#181b20);border-radius:14px;padding:22px;box-shadow:0 4px 20px rgba(0,0,0,.4);}
    .card-title{font-size:13px;font-weight:600;color:#7c3aed;text-transform:uppercase;letter-spacing:.05em;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid #2d3748;}
    .stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #1c1f26;font-size:14px;}
    .stat-row:last-child{border-bottom:none;}
    .stat-lbl{color:#9ca3af;}
    label{display:block;font-size:13px;color:#9ca3af;margin-bottom:6px;margin-top:12px;}
    input[type=number],input[type=text]{width:100%;box-sizing:border-box;background:#0f1115;border:1.5px solid #2d3748;color:#fff;padding:10px 13px;border-radius:8px;font-size:14px;outline:none;}
    input:focus{border-color:#7c3aed;}
    .btn{padding:10px 18px;border:none;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;display:inline-block;text-align:center;text-decoration:none;}
    .btn-purple{background:linear-gradient(180deg,#7c3aed,#6d28d9);color:#fff;}
    .btn-red{background:#7f1d1d;color:#fca5a5;}
    .btn-green{background:#14532d;color:#86efac;}
    .btn-block{width:100%;box-sizing:border-box;}
    .status-active{color:#4ade80;} .status-suspended{color:#f87171;}
    .alert{padding:12px 16px;border-radius:10px;margin-bottom:20px;font-size:14px;}
    .alert-success{background:#022c22;border:1px solid #166534;color:#4ade80;}
    .alert-error{background:#1f1014;border:1px solid #ef4444;color:#f87171;}
    .creds-box{background:#0f1115;border:1px solid #2d3748;border-radius:10px;padding:16px;margin-top:12px;}
    .creds-box p{margin:4px 0;font-size:14px;}
    .back-link{color:#6b7280;text-decoration:none;font-size:13px;display:inline-flex;align-items:center;gap:4px;}
    .back-link:hover{color:#9ca3af;}
    .action-btn-row{display:flex;flex-direction:column;gap:10px;}
    .backup-row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;}
    .backup-restore-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .file-input{background:#0f1115;border:1px solid #2d3748;color:#ccc;padding:7px 10px;border-radius:8px;font-size:13px;}
  </style>
</head>
<body>
<div class="sa-header">
  <span style="font-size:18px;font-weight:700;color:#fff"><%= appName %></span>
  <div class="sa-user">
    <div class="sa-user-label">Logged in as</div>
    <div class="sa-avatar"><%= (user.username || 'S').charAt(0).toUpperCase() %></div>
    <div class="sa-user-name"><%= user.username %></div>
  </div>
</div>
<div class="container">
  <a href="/portal" class="back-link">← Back to Dashboard</a>
  <h1 style="margin-top:20px;margin-bottom:6px;"><%= ws.name %></h1>
  <p class="subtitle">Slug: /w/<%= ws.slug %> &nbsp;&middot;&nbsp; Status: <span class="status-<%= ws.status %>"><%= ws.status === 'active' ? 'Active' : 'Suspended' %></span></p>

  <% if (created) { %>
    <div class="alert alert-success">Workspace created successfully!</div>
  <% } %>

  <% if (newCreds) { %>
    <div class="alert alert-success">
      Admin account created. Save these credentials:
      <div class="creds-box">
        <p><strong>Username:</strong> <%= newCreds.username %></p>
        <p><strong>Temporary Password:</strong> <code><%= newCreds.password %></code></p>
        <p><strong>Login URL:</strong> <a href="<%= newCreds.loginUrl %>" style="color:#3b82f6"><%= newCreds.loginUrl %></a></p>
      </div>
    </div>
  <% } %>

  <% if (ownerReset && ownerResetCreds) { %>
    <div class="alert alert-success">
      Owner password reset. This password will only be shown once — save it now:
      <div class="creds-box">
        <p><strong>Username:</strong> <%= ownerResetCreds.username %></p>
        <p><strong>Temporary Password:</strong> <code style="font-size:15px;letter-spacing:0.05em"><%= ownerResetCreds.tempPassword %></code></p>
        <p><strong>Login URL:</strong> <a href="<%= ownerResetCreds.loginUrl %>" style="color:#3b82f6"><%= ownerResetCreds.loginUrl %></a></p>
        <p style="color:#f87171;margin-top:8px;font-size:12px;">This password will not be shown again. The owner will be required to change it on first login.</p>
      </div>
    </div>
  <% } %>

  <% if (ownerResetError) { %>
    <div class="alert alert-error"><%= ownerResetError %></div>
  <% } %>

  <div class="grid">
    <!-- Stats -->
    <div class="card">
      <div class="card-title">Workspace Stats</div>
      <div class="stat-row"><span class="stat-lbl">Users</span> <span><%= ws.userCount %> / <%= ws.maxUsers %> used</span></div>
      <div class="stat-row"><span class="stat-lbl">Vehicles</span> <span><%= ws.vehicleCount %> / <%= ws.maxVehicles %> used</span></div>
      <div class="stat-row"><span class="stat-lbl">Questions</span> <span>Max <%= ws.maxQuestions || 5 %></span></div>
      <div class="stat-row"><span class="stat-lbl">Log Entries</span> <span><%= ws.logCount %></span></div>
      <div class="stat-row"><span class="stat-lbl">Last Activity</span> <span><%= ws.lastActivity ? new Date(ws.lastActivity).toLocaleDateString('en-AU') : 'Never' %></span></div>
      <div class="stat-row"><span class="stat-lbl">Status</span> <span class="status-<%= ws.status %>"><%= ws.status === 'active' ? 'Active' : 'Suspended' %></span></div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="card-title">Actions</div>
      <div class="action-btn-row" style="margin-top:8px;">
        <% if (ws.status === 'active') { %>
          <form method="POST" action="/portal/workspaces/<%= ws.id %>/suspend">
            <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
            <button class="btn btn-red btn-block" type="submit">Suspend Workspace</button>
          </form>
        <% } else { %>
          <form method="POST" action="/portal/workspaces/<%= ws.id %>/activate">
            <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
            <button class="btn btn-green btn-block" type="submit">Activate Workspace</button>
          </form>
        <% } %>
        <a href="/w/<%= ws.slug %>/login" target="_blank" class="btn btn-purple btn-block">Open Workspace Login</a>

        <% if (owner) { %>
          <a href="/portal/workspaces/<%= ws.id %>/login-as-owner" class="btn btn-block" style="background:#1e1435;color:#c084fc;border:1px solid #6d28d9;">
            Login as Owner (<%= owner.username %>)
          </a>
          <form method="POST" action="/portal/workspaces/<%= ws.id %>/reset-owner-password" onsubmit="return confirm('Reset the Owner account password? The temporary password will be displayed once.')">
            <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
            <button class="btn btn-block" type="submit" style="background:#1c1010;color:#f87171;border:1px solid #7f1d1d;width:100%;">
              Reset Owner Password
            </button>
          </form>
        <% } else { %>
          <div style="padding:10px 14px;background:#1c1010;border:1px dashed #7f1d1d;border-radius:9px;font-size:13px;color:#f87171;text-align:center;">
            No Owner account found for this workspace.
          </div>
        <% } %>

        <a href="/billing" target="_blank" class="btn btn-block" style="background:#0f1e0a;color:#4ade80;border:1px solid #166534;">Open Billing Profile</a>
      </div>
    </div>
  </div>

  <!-- Edit Limits -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">Edit Limits</div>
    <% if (limitsError) { %>
      <div class="alert alert-error" style="margin-bottom:12px;"><%= limitsError %></div>
    <% } %>
    <form method="POST" action="/portal/workspaces/<%= ws.id %>/limits" style="display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap">
      <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
      <div style="flex:1;min-width:130px">
        <label>Max Users <span style="color:#6b7280;font-size:11px">(currently <%= ws.userCount %> used)</span></label>
        <input type="number" name="maxUsers" value="<%= ws.maxUsers %>" min="1" max="9999">
      </div>
      <div style="flex:1;min-width:130px">
        <label>Max Vehicles <span style="color:#6b7280;font-size:11px">(currently <%= ws.vehicleCount %> used)</span></label>
        <input type="number" name="maxVehicles" value="<%= ws.maxVehicles %>" min="1" max="9999">
      </div>
      <div style="flex:1;min-width:130px">
        <label>Max Questions <span style="color:#6b7280;font-size:11px">(1–10)</span></label>
        <input type="number" name="maxQuestions" value="<%= ws.maxQuestions || 5 %>" min="1" max="10">
      </div>
      <div style="flex-shrink:0">
        <button class="btn btn-purple" type="submit">Save Limits</button>
      </div>
    </form>
  </div>

  <!-- Data Retention -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">Data Retention</div>
    <p style="color:#9ca3af;font-size:13px;margin:0 0 16px">Configure how long temperature logs are stored for this workspace.</p>
    <form method="POST" action="/portal/workspaces/<%= ws.id %>/retention" style="display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap">
      <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        <input type="checkbox" name="retentionEnabled" id="retEnabled" value="1" <%= (ws.settings && ws.settings.retentionEnabled) ? 'checked' : '' %>>
        <label for="retEnabled" style="color:#d1d5db;font-size:13px;margin:0">Enable Auto-Delete</label>
      </div>
      <div style="flex:1;min-width:160px">
        <label>Retain logs for (days)</label>
        <input type="number" name="retentionDays" value="<%= (ws.settings && ws.settings.retentionDays) ? ws.settings.retentionDays : 365 %>" min="30" max="3650">
      </div>
      <div style="flex-shrink:0">
        <button class="btn btn-purple" type="submit">Save Retention</button>
      </div>
    </form>
  </div>

  <!-- Backup & Restore -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">Backup &amp; Restore</div>
    <p style="color:#9ca3af;font-size:13px;margin:0 0 16px">Export a full backup of all workspace data. Restore from a previously exported backup file.</p>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div>
        <p style="font-size:12px;color:#6b7280;margin:0 0 8px;">Download a full backup of all data for this workspace.</p>
        <a href="/portal/workspaces/<%= ws.id %>/backup" class="btn btn-purple" style="text-decoration:none;display:inline-block;">Export Backup</a>
      </div>
      <hr style="border:none;border-top:1px solid #2d3748;margin:4px 0;">
      <div>
        <p style="font-size:12px;color:#6b7280;margin:0 0 8px;">Restore from a previously exported backup file. This will overwrite all current data.</p>
        <form method="POST" action="/portal/workspaces/<%= ws.id %>/restore" enctype="multipart/form-data" onsubmit="return confirm('Restore will overwrite all current workspace data. Are you sure?')">
          <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <input type="file" name="backupFile" accept=".json" required class="file-input" style="flex:1;min-width:200px;">
            <button class="btn btn-red" type="submit" style="white-space:nowrap;">Restore Backup</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</body>
</html>
