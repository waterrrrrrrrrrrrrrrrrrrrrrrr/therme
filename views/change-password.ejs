<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set Your Password ‚Äî <%= typeof appName !== 'undefined' ? appName : 'Thermio' %></title>
  <link rel="stylesheet" href="/app.css">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--bg);
      padding: var(--sp-lg);
    }
    .pw-card {
      background: linear-gradient(180deg, var(--bg2), var(--bg3));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--sp-xl) 36px;
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }
    .pw-card-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: var(--sp-lg);
    }
    .pw-card-brand-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--blue), #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: white;
    }
    .pw-card-brand-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }
    .pw-card h2  { font-size: 20px; font-weight: 800; margin: 0 0 6px; }
    .pw-card > p { color: var(--text-muted); font-size: 14px; margin: 0 0 var(--sp-lg); line-height: 1.5; }
    .btn-full {
      width: 100%;
      padding: 13px;
      background: linear-gradient(180deg, var(--blue), #2563eb);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: var(--sp-md);
      transition: filter 0.2s;
    }
    .btn-full:not(:disabled):hover { filter: brightness(1.1); }
    .btn-full:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
<div class="pw-card">

  <!-- Brand -->
  <div class="pw-card-brand">
    <% if (workspace && workspace.branding && workspace.branding.favicon) { %>
      <img src="<%= workspace.branding.favicon %>" style="width:36px;height:36px;border-radius:8px;object-fit:cover;" alt="Logo">
    <% } else { %>
      <div class="pw-card-brand-icon">üîê</div>
    <% } %>
    <span class="pw-card-brand-name"><%= workspace ? workspace.name : (typeof appName !== 'undefined' ? appName : 'Thermio') %></span>
  </div>

  <h2>Set Your Password</h2>
  <p>You must create a secure password before continuing. This only needs to be done once.</p>

  <% if (error) { %>
    <div class="alert alert-error" style="margin-bottom:var(--sp-md);"><%= error %></div>
  <% } %>

  <form method="POST" action="/change-password" id="pwForm">
    <input type="hidden" name="_security-token" value="<%= security-tokenToken %>">
    <div class="form-group">
      <label>New Password</label>
      <input
        type="password"
        name="newPassword"
        id="newPassword"
        required
        minlength="8"
        autofocus
        autocomplete="new-password"
        placeholder="Create a strong password"
      >
      <!-- Strength indicator -->
      <div class="password-strength-wrap" style="margin-top:8px;">
        <div class="password-strength-bar">
          <div class="password-strength-fill" id="strengthFill"></div>
        </div>
        <span class="password-strength-label" id="strengthLabel"></span>
      </div>
      <!-- Requirements -->
      <div class="password-requirements" style="margin-top:10px;">
        <p>Password Requirements</p>
        <div class="req-item" id="req-length"><span class="req-dot"></span>At least 8 characters</div>
        <div class="req-item" id="req-upper"><span class="req-dot"></span>At least 1 uppercase letter (A-Z)</div>
        <div class="req-item" id="req-number"><span class="req-dot"></span>At least 1 number (0-9)</div>
        <div class="req-item" id="req-special"><span class="req-dot"></span>At least 1 special character (!@#$%...)</div>
      </div>
    </div>

    <div class="form-group">
      <label>Confirm New Password</label>
      <input
        type="password"
        name="confirmPassword"
        id="confirmPassword"
        required
        minlength="8"
        autocomplete="new-password"
        placeholder="Confirm your password"
      >
      <!-- Live match indicator -->
      <div class="pw-match-hint" id="matchHint"></div>
    </div>

    <button
      class="btn-full"
      type="submit"
      id="submitBtn"
      disabled
    >Set Password &amp; Continue</button>
  </form>
</div>

<script>
function checkStrength(password) {
  const reqs = {
    length:  password.length >= 8,
    upper:   /[A-Z]/.test(password),
    number:  /[0-9]/.test(password),
    special: /[^A-Za-z0-9]/.test(password)
  };

  ['length','upper','number','special'].forEach(k => {
    const el = document.getElementById('req-' + k);
    if (el) el.classList.toggle('met', reqs[k]);
  });

  const score = Object.values(reqs).filter(Boolean).length;
  const fill  = document.getElementById('strengthFill');
  const label = document.getElementById('strengthLabel');

  if (!password) {
    fill.className  = 'password-strength-fill';
    label.textContent = '';
    label.className   = 'password-strength-label';
    updateSubmitBtn();
    return;
  }

  let strength = 'weak';
  if (score >= 4) strength = 'strong';
  else if (score >= 2 && reqs.length) strength = 'medium';

  fill.className  = 'password-strength-fill ' + strength;
  label.textContent = strength.charAt(0).toUpperCase() + strength.slice(1);
  label.className   = 'password-strength-label ' + strength;

  updateSubmitBtn();
}

function checkMatch() {
  const pw1 = document.getElementById('newPassword').value;
  const pw2 = document.getElementById('confirmPassword').value;
  const hint = document.getElementById('matchHint');

  if (!pw2) {
    hint.className = 'pw-match-hint';
    hint.textContent = '';
    updateSubmitBtn();
    return;
  }

  if (pw1 === pw2) {
    hint.className = 'pw-match-hint match';
    hint.innerHTML = '‚úì Passwords match';
  } else {
    hint.className = 'pw-match-hint nomatch';
    hint.innerHTML = '‚úó Passwords do not match';
  }
  updateSubmitBtn();
}

function updateSubmitBtn() {
  const pw1 = document.getElementById('newPassword').value;
  const pw2 = document.getElementById('confirmPassword').value;
  // Only require minimum length + match ‚Äî strength bar is informational only
  const longEnough = pw1.length >= 8;
  const matched    = pw1 === pw2 && pw2.length > 0;
  document.getElementById('submitBtn').disabled = !(longEnough && matched);
}

// Attach input listeners ‚Äî no inline handlers (CSP blocks script-src-attr)
document.getElementById('newPassword').addEventListener('input', function() {
  checkStrength(this.value);
  checkMatch();
});
document.getElementById('confirmPassword').addEventListener('input', function() {
  checkMatch();
});

// Prevent submit if mismatch
document.getElementById('pwForm').addEventListener('submit', function(e) {
  const pw1 = document.getElementById('newPassword').value;
  const pw2 = document.getElementById('confirmPassword').value;
  if (pw1 !== pw2) {
    e.preventDefault();
    const hint = document.getElementById('matchHint');
    hint.className = 'pw-match-hint nomatch';
    hint.innerHTML = '‚úó Passwords do not match';
  }
});
</script>
</body>
</html>
