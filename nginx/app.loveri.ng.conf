# /etc/nginx/sites-available/app.loveri.ng
# Thermio TMS — Production Nginx Configuration
# Designed for: Cloudflare Full (Strict) SSL + Let's Encrypt backend cert
#
# HOW SSL WORKS:
#   Browser → Cloudflare (HTTPS, Cloudflare cert) → This server (HTTPS, Let's Encrypt cert)
#   Cloudflare Full (Strict) requires a VALID cert on origin — Let's Encrypt satisfies this.
#
# IMPORTANT: After editing, always run:
#   sudo nginx -t && sudo systemctl reload nginx

# ── Rate limiting zones ────────────────────────────────────────
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m   rate=60r/m;

# ── HTTP → HTTPS redirect ──────────────────────────────────────
server {
    listen 80;
    server_name app.loveri.ng;

    # Let's Encrypt ACME challenge (cert renewal)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ── Main HTTPS server ──────────────────────────────────────────
server {
    listen 443 ssl http2;
    server_name app.loveri.ng;

    # ── SSL — Let's Encrypt ─────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/app.loveri.ng/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.loveri.ng/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # ── Logging ─────────────────────────────────────────────────
    access_log /var/log/nginx/thermio-access.log;
    error_log  /var/log/nginx/thermio-error.log warn;

    # ── Upload size (branding, exports) ─────────────────────────
    client_max_body_size 15M;

    # ── Additional security headers (Helmet handles most) ────────
    add_header X-Frame-Options        "DENY"                            always;
    add_header X-Content-Type-Options "nosniff"                         always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy     "camera=(), microphone=(), geolocation=()" always;

    # ── Block hidden files (.env, .git, etc.) ───────────────────
    location ~ /\. {
        deny all;
        return 404;
    }

    # ── Rate limiting: Login routes ─────────────────────────────
    location ~ ^/(login|w/[^/]+/login|portal/login) {
        limit_req zone=login burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://127.0.0.1:3000;
        include /etc/nginx/thermio_proxy_params;
    }

    # ── Rate limiting: API ───────────────────────────────────────
    location /api/ {
        limit_req zone=api burst=15 nodelay;
        limit_req_status 429;
        proxy_pass http://127.0.0.1:3000;
        include /etc/nginx/thermio_proxy_params;
    }

    # ── Static asset caching ─────────────────────────────────────
    # Express serves /app.css, /media/*, /uploads/* at root.
    # Cache CSS, JS, images for 7 days.
    location ~* \.(css|js|ico|png|jpg|jpeg|webp|svg|gif|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3000;
        include /etc/nginx/thermio_proxy_params;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # ── All other requests → Node.js ────────────────────────────
    location / {
        proxy_pass http://127.0.0.1:3000;
        include /etc/nginx/thermio_proxy_params;
    }
}
